# Vibe check

A web-based tool to help concept developers understand how classifiers might perform on real-world documents, before going through the formal classifier evaluation process.

The site displays predictions for each candidate classifier by highlighting the predicted text spans from each model. It also allows users to search the predicted passages and filter by region, translation status, and corpus type.

The generated site has the following structure, stored in the `dist` directory:

```
dist/
├── index.html                # List of all concepts
├── static/                   # Static assets (CSS, JS, images)
└── {concept_id}/             # Directory for each concept
    ├── index.html            # Concept details and available classifiers
    ├── {classifier_id}.html  # Predictions for a specific classifier
    └── {classifier_id}.json  # Raw predictions in JSONL format
```

## Generating the site with new data

Before generating the site, ensure you have run the prediction pipeline:

```bash
just predict Q123  # Replacing Q123 with your concept ID
```

To generate a new set of HTML files with the latest predictions, run:

```bash
just generate-static-site vibe_check
```

The HTML files will be saved locally to the `static_sites/vibe_check/dist` directory.

To preview the site locally, you can start a local server:

```bash
just serve-static-site vibe_check
```

The site will be available at `http://localhost:8080`.

## Deployment

The site is deployed using AWS CloudFront and S3.

### Deploy the infrastructure

This step is only required if you're making changes to the infrastructure itself - skip it if you're just updating the site content, and move straight on to [Pushing new data to s3](#pushing-new-data-to-s3).

```bash
# First, navigate to the infrastructure directory
cd static_sites/vibe_check/infra

# Install dependencies
pip install -r requirements.txt

# Deploy and get the outputs
pulumi up --stack labs
```

The deployment creates:

- An S3 bucket (`cpr-knowledge-graph-vibe-check`) configured for static website hosting
- A CloudFront distribution providing:
  - HTTPS support with automatic HTTP to HTTPS redirection
  - Clean URLs (no index.html suffixes needed) via CloudFront Functions
  - Global CDN distribution (using Price Class 100 edge locations)
  - HTTP/2 and IPv6 support
  - Optimised caching using AWS's managed CachingOptimized policy
  - Limited to GET, HEAD, and OPTIONS methods for security
- Appropriate security policies and access controls via Origin Access Identity (OAI)

The infrastructure is defined using Pulumi in `infra/__main__.py`.

### Pushing new data to s3

Once the infrastructure is ready, you can deploy the static site files. The deployment can be done either automatically via the Prefect flow or manually:

#### Automatic deployment (recommended)

The site is automatically deployed nightly via the `deploy_static_sites` Prefect flow. You can also trigger it manually from the Prefect console.

#### Manual deployment

If you need to deploy manually (ensure you have AWS credentials configured with the `labs` profile):

```bash
# get the bucket name from the pulumi stack outputs
export BUCKET_NAME=$(pulumi stack output bucket_name --stack labs)

# Sync the dist directory to S3, removing any old files
aws s3 sync dist "s3://$BUCKET_NAME/dist" --profile=labs --delete

# The site will be available at the CloudFront URL, which you can get with:
pulumi stack output cloudfront_url --stack labs
```

## Managing Persistent Experimental Results

The vibe check system displays two types of classifier results:

### Nightly data

Every night, a new classifier is automatically retrained and a fresh set of labelled passages are regenerated for the concepts listed in `pipeline/classifier_specs/prod.yaml`. The classifier used for each concept will be the default output of the `ClassifierFactory.create()` for the given concept. The results are overwritten each night, based on the latest data from the concept store.

### Persistent data

Occasionally, we want to run qualitative checks on the results of experimental classifiers which aren't output by the `ClassifierFactory`. To see these results in the deployed site, we can upload individual lists of labelled passages to the s3 bucket's `/persistent` subdirectory. These results will not be overwritten each night - the build process will integrate the results in `/persistent` with the rest of the nightly-autogenerated results in the final `/dist`. The `/persistent` subdirectory is only read by the build process, so the results will remain there to be picked up again the following night. It's therefore up to the users/maintainers of the site to make sure that the results in `/persistent` are being used, and to clear out experiments when they stop being useful.

### Data Structure

The S3 bucket is organised as follows:

```
s3://cpr-knowledge-graph-vibe-check/
├── dist/                          # Generated website (served by CloudFront)
│   ├── index.html
│   ├── static/
│   │   ├── favicon.png
│   │   └── js/
│   └── Q123/
│       ├── index.html
│       ├── classifier1.html       # For display in browser
│       ├── classifier1.json       # Can be downloaded for deeper analysis
│       ├── experimental1.html
│       └── experimental1.json     
└── persistent/                    # Manual uploads, will be persisted until deleted
    ├── passages_dataset.feather   # Nightly inference is run on this dataset
    ├── Q789/
    │   ├── experimental1.json
    │   └── experimental2.json
    └── Q101/
        └── my_custom_model.json
```

### Uploading Experimental Results

To add persistent experimental results that will appear in the vibe check interface:

1. **Prepare your JSON file**: The file should contain predictions in JSONL format (one `LabelledPassage` JSON object per line)

2. **Upload to S3**: Upload your file to the persistent directory for the appropriate concept:

    ```bash
    # Upload experimental results for concept Q123
    aws s3 cp my_experimental_results.json \
      s3://cpr-knowledge-graph-vibe-check/persistent/Q123/my_experimental_results.json \
      --profile=labs
    ```

    To match the format of the rest of the nightly auto-generated results, you should replace `my_experimental_results` with the id of your classifier in the above command.

3. **Wait for next deployment**: The results will appear in the vibe check interface after the next nightly site generation. To deploy immediately, you can either:

    - run `just generate-static-site vibe_check`, followed by `aws s3 sync static_sites/vibe_check/dist s3://cpr-knowledge-graph-vibe-check/dist --delete --profile=labs`, or
    - trigger the flow manually in the prefect console

### JSON Format Requirements

Your JSON file must be in JSONL format, where each line is a separate serialised `LabelledPassage` JSON object.

### Managing Persistent Data

#### Upload experimental results

```bash
# For concept Q123
aws s3 cp my_experimental_results.json s3://cpr-knowledge-graph-vibe-check/persistent/Q123/my_experimental_results.json --profile=labs
```

#### Delete experimental results

```bash
# Remove a specific classifier's results
aws s3 rm s3://cpr-knowledge-graph-vibe-check/persistent/Q123/my_experimental_results.json --profile=labs

# Remove all experimental results for a concept
aws s3 rm s3://cpr-knowledge-graph-vibe-check/persistent/Q123/ --recursive --profile=labs
```

### Tearing down the infrastructure

To tear everything down, make your way to the `infra` directory and run:

```bash
pulumi destroy --stack labs
```
